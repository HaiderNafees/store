<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Grocofy</title>
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="admin-body">
    <div class="admin-container">
        <!-- Add this script at the top to check auth before anything else renders -->
        <script>
            // Check authentication
            if (localStorage.getItem('adminLoggedIn') !== 'true') {
                window.location.href = '../auth/login.html';
                console.log('Not logged in, redirecting to login page');
            } else {
                console.log('Admin is logged in, loading admin panel');
            }
            
            // Add a class to body for mobile detection
            document.addEventListener('DOMContentLoaded', function() {
                if (window.innerWidth <= 992) {
                    document.body.classList.add('mobile-view');
                }
                
                window.addEventListener('resize', function() {
                    if (window.innerWidth <= 992) {
                        document.body.classList.add('mobile-view');
                        // Close sidebar by default on mobile
                        document.body.classList.add('sidebar-collapsed');
                        const sidebar = document.querySelector('.admin-sidebar');
                        const mainContent = document.querySelector('.admin-main');
                        if (sidebar) sidebar.classList.add('collapsed');
                        if (mainContent) mainContent.classList.add('expanded');
                    } else {
                        document.body.classList.remove('mobile-view');
                        // Open sidebar by default on desktop
                        document.body.classList.remove('sidebar-collapsed');
                        const sidebar = document.querySelector('.admin-sidebar');
                        const mainContent = document.querySelector('.admin-main');
                        if (sidebar) sidebar.classList.remove('collapsed');
                        if (mainContent) mainContent.classList.remove('expanded');
                    }
                });
            });
        </script>
        <!-- Sidebar Overlay (for mobile) -->
        <div class="sidebar-overlay"></div>
        
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2>Grocofy</h2>
                <p>Admin Panel</p>
            </div>
            
            <nav class="sidebar-nav">
                <ul>
                    <li class="active" data-section="dashboard-section">
                        <a href="#" data-section="dashboard-section">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li data-section="products-section">
                        <a href="#" data-section="products-section">
                            <i class="fas fa-box"></i>
                            <span>Products</span>
                        </a>
                    </li>
                    <li data-section="categories-section">
                        <a href="#" data-section="categories-section">
                            <i class="fas fa-tags"></i>
                            <span>Categories</span>
                        </a>
                    </li>
                    <li data-section="orders-section">
                        <a href="#" data-section="orders-section">
                            <i class="fas fa-shopping-cart"></i>
                            <span>Orders</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <div class="admin-profile">
                    <div class="admin-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="admin-info">
                        <h4 id="adminName">Admin User</h4>
                        <p id="adminEmail">admin@example.com</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <div class="header-left">
                    <button class="menu-toggle" aria-label="Toggle menu">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Dashboard</h1>
                </div>
                <div class="header-right">
                    <!-- Header profile removed for cleaner design -->
                </div>
            </header>
            
            <!-- Main Content -->
            <div class="admin-content">
                <!-- Dashboard Section -->
                <section id="dashboard-section" class="content-section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="stat-info">
                                <h3>Total Products</h3>
                                <p id="totalProducts">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-tags"></i>
                            </div>
                            <div class="stat-info">
                                <h3>Categories</h3>
                                <p id="totalCategories">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-info">
                                <h3>Total Orders</h3>
                                <p id="totalOrders">0</p>
                            </div>
                        </div>
                    </div>
                    
                </section>
                
                <!-- Products Section -->
                <section id="products-section" class="content-section">
                    <div class="section-header">
                        <h2>Manage Products</h2>
                        <div class="section-actions">
                            <button class="btn btn-secondary" id="refreshProductsBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-primary" id="addProductBtn">
                                <i class="fas fa-plus"></i> Add Product
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Products will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </section>
                
                <!-- Categories Section -->
                <section id="categories-section" class="content-section">
                    <div class="section-header">
                        <h2>Manage Categories</h2>
                        <button class="btn btn-primary" id="addCategoryBtn">
                            <i class="fas fa-plus"></i> Add Category
                        </button>
                    </div>
                    
                    <div class="categories-grid" id="categoriesGrid">
                        <!-- Categories will be loaded here -->
                    </div>
                </section>
                
                <!-- Orders Section -->
                <section id="orders-section" class="content-section">
                    <h2>Recent Orders</h2>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <!-- Orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Mobile navigation indicator -->
    <div id="mobile-nav-indicator" style="display: none;"></div>
    
    <!-- Add Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Product</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="form-group">
                        <label for="productName">Product Name</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label for="productCategory">Category</label>
                        <select id="productCategory" required>
                            <!-- Categories will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Price ($)</label>
                        <input type="number" id="productPrice" min="0.01" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="productStock">Stock</label>
                        <input type="number" id="productStock" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productDescription">Description</label>
                        <textarea id="productDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Product Image</label>
                        <div class="image-upload">
                            <input type="file" id="productImage" accept="image/*">
                            <label for="productImage" class="upload-btn">
                                <i class="fas fa-upload"></i> Choose Image
                            </label>
                            <div id="imagePreview" class="image-preview"></div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelProductBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content small">
            <div class="modal-header">
                <h3>Confirm Action</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure you want to perform this action?</p>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelConfirmBtn">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Load scripts first -->
    <script src="../js/admin-auth.js"></script>
    <script src="../js/admin.js"></script>
    
    <!-- Direct navigation initialization -->
    <script>
    // Direct navigation handling as a fallback
    function handleDirectNavigation() {
        console.log('Setting up direct navigation...');
        
        // Get all navigation links
        const navLinks = document.querySelectorAll('.sidebar-nav a[data-section]');
        const contentSections = document.querySelectorAll('.content-section');
        
        // Function to show a section
        function showSection(sectionId) {
            console.log('Showing section:', sectionId);
            
            // Hide all sections
            contentSections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Show the selected section
            const targetSection = document.getElementById(`${sectionId}-section`);
            if (targetSection) {
                targetSection.classList.add('active');
                
                // Update active state in navigation
                navLinks.forEach(link => {
                    if (link.parentElement) {
                        link.parentElement.classList.remove('active');
                        if (link.getAttribute('data-section') === sectionId) {
                            link.parentElement.classList.add('active');
                        }
                    }
                });
                
                // Update URL
                if (sectionId === 'dashboard') {
                    window.history.pushState(null, '', window.location.pathname);
                } else {
                    window.history.pushState(null, '', `#${sectionId}-section`);
                }
                
                console.log('Section shown:', sectionId);
            } else {
                console.error('Section not found:', sectionId);
            }
        }
        
        // Add click event to navigation links
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.getAttribute('data-section').replace('-section', '');
                showSection(section);
                
                // Close sidebar on mobile
                if (window.innerWidth <= 992) {
                    document.body.classList.add('sidebar-collapsed');
                    const sidebar = document.querySelector('.admin-sidebar');
                    const mainContent = document.querySelector('.admin-main');
                    const overlay = document.querySelector('.sidebar-overlay');
                    if (sidebar) sidebar.classList.add('collapsed');
                    if (mainContent) mainContent.classList.add('expanded');
                    if (overlay) overlay.classList.remove('show');
                }
            });
        });
        
        // Handle initial load with hash
        function handleInitialLoad() {
            const hash = window.location.hash.replace('#', '').replace('-section', '') || 'dashboard';
            showSection(hash);
        }
        
        // Handle hash changes
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash.replace('#', '').replace('-section', '') || 'dashboard';
            showSection(hash);
        });
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', handleInitialLoad);
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', handleInitialLoad);
        } else {
            // DOM already loaded, run immediately
            setTimeout(handleInitialLoad, 100);
        }
        
        console.log('Direct navigation setup complete');
    }
    
    // Initialize the admin panel with fallback
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded, initializing admin panel...');
        
        // Try to use the main admin panel initialization
        if (typeof initAdminPanel === 'function') {
            console.log('Using main admin panel initialization');
            initAdminPanel();
        } else {
            console.log('Main admin panel not available, using direct navigation');
            // Fallback to direct navigation
            handleDirectNavigation();
            
            // Try again after a short delay in case scripts are still loading
            setTimeout(function() {
                if (typeof initAdminPanel === 'function') {
                    console.log('Admin panel loaded, initializing now');
                    initAdminPanel();
                } else {
                    console.log('Using direct navigation only');
                }
            }, 500);
        }
    });
    </script>
</body>
</html>
